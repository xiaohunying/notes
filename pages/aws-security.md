# AWS Security

- [Identity And Access Management (IAM)](#identity-and-access-management-iam)

# Identity And Access Management (IAM)

IAM is to manage, control and govern authentication, authorization and access control mechanisms of 
identities of your resources within your AWS Account. Identities are required to authenticate AWS accounts.
Access Management relates to authorization and access control. IAM is a global service.

Access control:
- username and password 
- [multi-factor authentication (MFA)](#multi-factor-authentication-mfa) 
- [federated access](#identity-federation)

IAM components:
- [Users](#users)
- [Groups](#groups)
- [Roles](#roles)
- [Policy Permissions](#policies)
- Access Control Mechanisms

### Users

A user can represent a real person who requires access to operate and maintain your AWS environment or
it can be an account used by an application that requires permissions to access your AWS resources
programmatically.

Access keys are required for programmatic access for authentication. These keys must be applied and
associated with your application. If you're using the AWS CLI to access a resource, you first have 
to instruct the AWS CLI to use these Access Keys. this association ensures that all API request
are signed with this digital signature.
- Access Key ID - Made up of 20 random uppercase alphanumeric characters.
- Secret Access Key ID - Made up of 40 random upper and lowercase characters. 
It's notpossible to retrieve lost Secret Access Key IDs!

**AWS CodeCommit** is a managed source control service. It allows you to host secure and scalable 
private Git repositories.

### Groups

IAM Groups are not used in authentication process. They are used to authorize access through AWS Policies.
IAM Groups contain IAM Users and have IAM policies associated. (AWS managed policies and/or Customer managed
policies)

### Roles

For example, you have an EC2 instance running an application that requires access to Amazon S3 to Put
and Get objects using the relevant API calls. You can assign an IAM Role to the EC2 instance. You should
always associate a role to an EC2 instance for accessing AWS resources over storing local credentials
on the instance itself.

Roles don't have any access keys or credentials associated with them. The credentials are dynamically 
assigned by AWS. You can alter the permissions assigned to the Role and all the EC2 instance associated 
will have the correct access.

There are currently 4 different types of Roles:
- AWS Service Role
- AWS Service-Linked Role - These roles do not allow you to modify permissions assigned.
- Role for Cross-Account Access. This role type offer two options:
  - Option 1: provide access between AWS accounts that you own.
  - Option 2: provide access between an account that you own and a third party AWS account.
  - The **trusting** account has the resources that need to be accessed. The **trusted** account contains 
  users that need to access the resources in the trusting account.
    1) A role is created in the trusting account.
    2) A trust is established with teh role by the AWS account number of the trusted account.
    3) Permissions are applied to the Role via **policies**.
    4) The users in the trusted account have a **policy** attached.
- Role for Identity Provider Access
  - Grant access to web identity providers - creates a trust for users using Amazon Cognito, amazon, Facebook,
  Google or other provider.
  - Grant Web Single Sign On to SAML Providers - allows access for users coming from a Security Assertion
  Markup Language (SAML) provider.
  - Grant API access to SAML Providers - Allows access from SAML provider via the AWS CLI, SDKs or API calls. 

### Policies

IAM Policies are used to assign permissions. They are formatted as a JSON document and have at least one 
statement with this structure:

~~~json
{
    "Version": "2020-12-25",
    "Statement": [
      {
        "Sid": "Stmt123456789012",
        "Action": "cloudtrail:*",
        "Effect": "Allow",
        "Resource": "*",
        "Condition": {
          "IpAddress": {
            "aws:SourceIp": "10.10.0.0/16"
          }
        }
      }
    ]
}
~~~

There are two types of IAM Policies: 
- Managed Policies
  - AWS Managed Policies
  - Customer Managed Policies
- In-line Policies
  - They are directly embedded into a specific user, group or role.
  - If there are conflicting permissions assigned to the same user, follow:
    - By default, all access is denied.
    - Access will only be allowed if an explicit "Allow" has been specified.
    - A single "Deny" will overrule any "Allow".
  

## Multi-Factor Authentication (MFA)

MFA utilizes a random 6 digit number generated by an MFA device. There is no additional charge for this. You need 
to own a MFA device which can be a physical token or a virtual device. The MFA device must be configured and 
associated to the user. This configuration can be done from within IAM.

## Identity Federation

Identity federation allows you to access and manage AWS resources even if you don't have a user account
within IAM. Identity providers (IdP) allow users to access AWS resources securely. There must be a trust 
relationship between the IdP and your AWS account. AWS supports two types of IdP:
- OpenID such as Facebook, Google, Amazon. Amazon Cognito
- SAML (Security Assertion Markup Language): allows your existing MS-AD users to authenticate to your AWS
resources on a SSO approach.

**Security Token Service (STS)** allows you to gain temporary security credentials for federated users via IAM.

An example:

1. The user initiates a request to authenticate against the **ADFS server** via a web browser using a **SSO URL**.
2. If the authentication is successful by the AD credentials, SAML will then issues a **successful authentication
assertion** back to the users' client requesting federated access.
3. The SAML assertion is sent to the AWS STS to assume a role within IAM using the **AssumeRoleWithSAML API**.
4. STS responds to the user requesting federated access with temporary security credentials with an assumed
role and associated permissions.
5. The user then has federated access to the necessary AWS services as per the role permissions.

## Features of IAM

- Account settings - password policy and security token service regions.
- Credential Report - a list of all your IAM users and credentials. The report will only be generated once in 4 hours.
- Key Management Service (KMS)

<br />

